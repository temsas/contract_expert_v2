<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden { display: none; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 25px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .format-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üîç –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 44-–§–ó –∏ 223-–§–ó</p>

        <div class="card">
            <h2>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h2>

            <div class="format-info">
                <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong> PDF, DOC, DOCX
            </div>

            <form id="uploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="law_type">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
                    <select id="law_type" name="law_type" required>
                        <option value="44_fz">44-–§–ó</option>
                        <option value="223_fz">223-–§–ó</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contract_file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç:</label>
                    <input type="file" id="contract_file" name="contract_file"
                           accept=".pdf,.doc,.docx" required>
                </div>

                <button type="submit" id="analyzeBtn">
                    {% if AI_AVAILABLE %}
                        üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                    {% else %}
                        ‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                    {% endif %}
                </button>
            </form>
        </div>

        <div id="result" class="card hidden">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
            <div id="analysisResult"></div>
        </div>

        <!-- ======================== -->
        <!-- üì¶ –ú–û–î–£–õ–¨ –ü–û–î–ë–û–†–ê –ü–û–°–¢–ê–í–©–ò–ö–û–í -->
        <!-- ======================== -->
        <div class="card">
            <h2>üì¶ –ü–æ–¥–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</h2>
            <form id="supplierForm">
                <div class="form-group">
                    <label for="purchase_method">–°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏:</label>
                    <input type="text"
                           id="purchase_method"
                           name="purchase_method"
                           list="purchase_methods"
                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Å–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏..."
                           required>
                    <datalist id="purchase_methods">
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="category">–í–∏–¥ –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞–∫—É–ø–∫–∏:</label>
                    <input type="text"
                           id="category"
                           name="category"
                           list="categories"
                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é..."
                           required>
                    <datalist id="categories">
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </datalist>
                </div>
                <button type="submit">–ù–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</button>
            </form>

            <div id="supplierResult" class="hidden">
                <h3>–¢–û–ü-5 –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</h3>
                <ul id="supplierList"></ul>
            </div>
        </div>
    </div>

    <script>
        // –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const resultDiv = document.getElementById('analysisResult');
            const resultCard = document.getElementById('result');

            resultCard.classList.remove('hidden');
            resultDiv.innerHTML = '<p>‚è≥ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞...</p>';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `
                        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ${data.law_type.toUpperCase()}</h3>
                        <p><strong>–§–∞–π–ª:</strong> ${data.filename}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong> <span style="font-weight: bold; color: ${
                            data.analysis.compliance_status === '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'green' :
                            data.analysis.compliance_status === '—á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'orange' : 'red'
                        }">${data.analysis.compliance_status}</span></p>
                        <p><strong>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:</strong> ${data.analysis.summary}</p>
                    `;

                    if (data.analysis.issues && data.analysis.issues.length > 0) {
                        html += '<h4>–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4><ul>';
                        data.analysis.issues.forEach(issue => {
                            html += `
                                <li style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #e74c3c;">
                                    <strong>${issue.article}:</strong> ${issue.issue}
                                    <br><em>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</em> ${issue.recommendation}
                                </li>
                            `;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: green; font-weight: bold;">‚úÖ –ù–∞—Ä—É—à–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</p>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
            }
        });

        // ========================
        // üì¶ –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –î–õ–Ø –ü–û–õ–ï–ô –ü–û–°–¢–ê–í–©–ò–ö–û–í
        // ========================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadPurchaseMethods();
            loadCategories();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–∫—É–ø–∫–∏
        async function loadPurchaseMethods() {
            try {
                const response = await fetch('/api/purchase-methods');
                const methods = await response.json();

                const datalist = document.getElementById('purchase_methods');
                datalist.innerHTML = '';

                methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–∫—É–ø–∫–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();

                const datalist = document.getElementById('categories');
                datalist.innerHTML = '';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('purchase_method').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length >= 2) {
                searchPurchaseMethods(query);
            }
        });

        document.getElementById('category').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length >= 2) {
                searchCategories(query);
            }
        });

        async function searchPurchaseMethods(query) {
            try {
                const response = await fetch(`/api/search-purchase-methods/${encodeURIComponent(query)}`);
                const methods = await response.json();

                const datalist = document.getElementById('purchase_methods');
                datalist.innerHTML = '';

                methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–∫—É–ø–∫–∏:', error);
            }
        }

        async function searchCategories(query) {
            try {
                const response = await fetch(`/api/search-categories/${encodeURIComponent(query)}`);
                const categories = await response.json();

                const datalist = document.getElementById('categories');
                datalist.innerHTML = '';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        document.getElementById('supplierForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const method = document.getElementById('purchase_method').value;
            const category = document.getElementById('category').value;

            const resultDiv = document.getElementById('supplierResult');
            const list = document.getElementById('supplierList');
            list.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch('/suppliers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({purchase_method: method, category: category})
                });
                const data = await response.json();
                if (data.status === 'success' && data.suppliers.length > 0) {
                    list.innerHTML = '';
                    data.suppliers.forEach(s => {
                        list.innerHTML += `
                            <li>
                                <strong>${s.name}</strong> ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ ${s.rating}‚≠ê
                                <br>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${s.category}, —Å–ø–æ—Å–æ–±: ${s.purchase_method}
                                <br>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: ${s.contracts_count}, —Å—É–º–º–∞: ${s.total_sum.toLocaleString()} ‚Ç∏
                            </li>`;
                    });
                } else {
                    list.innerHTML = '<li>‚ùå –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
                }
            } catch (err) {
                list.innerHTML = `<li>–û—à–∏–±–∫–∞: ${err}</li>`;
            }
        });
    </script>
</body>
</html>