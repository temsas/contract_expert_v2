<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden { display: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 25px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .format-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px; }
        .update-btn { background: #28a745; margin-left: 10px; }
        .update-btn:hover { background: #218838; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        .suppliers-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .suppliers-table th, .suppliers-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .suppliers-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .suppliers-table tr:hover { background: #f8f9fa; }
        .rating {
            color: #ffc107;
            font-weight: bold;
            font-size: 13px;
        }
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #6c757d; }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ */
        .supplier-name {
            font-weight: bold;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center;">
            <h1>üîç –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 44-–§–ó –∏ 223-–§–ó</p>
        </div>
        <div class="card">
            <h2>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h2>
            <div class="format-info">
                <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong> PDF, DOC, DOCX
            </div>

            <form id="uploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="law_type">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
                    <select id="law_type" name="law_type" required>
                        <option value="44_fz">44-–§–ó</option>
                        <option value="223_fz">223-–§–ó</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contract_file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç:</label>
                    <input type="file" id="contract_file" name="contract_file"
                           accept=".pdf,.doc,.docx" required>
                </div>

                <button type="submit" id="analyzeBtn">
                    {% if AI_AVAILABLE %}
                        üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                    {% else %}
                        ‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                    {% endif %}
                </button>
            </form>
        </div>

        <div id="result" class="card hidden">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
            <div id="analysisResult"></div>
        </div>

        <div class="card">
            <h2>üì¶ –ü–æ–¥–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏–∑ goszakup.gov.kz</h2>

            <div class="format-info">
                <strong>–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞ goszakup.gov.kz –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</strong>
            </div>

            <div class="filters-section">
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label for="purchase_method">–°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏:</label>
                        <select id="purchase_method" name="purchase_method" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏...</option>
                            <option value="–ò–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—É—Ç–µ–º –ø—Ä—è–º–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞">–ò–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞</option>
                            <option value="–ß–µ—Ä–µ–∑ —Ç–æ–≤–∞—Ä–Ω—ã–µ –±–∏—Ä–∂–∏">–ß–µ—Ä–µ–∑ —Ç–æ–≤–∞—Ä–Ω—ã–µ –±–∏—Ä–∂–∏</option>
                            <option value="–û—Ç–∫—Ä—ã—Ç—ã–π –∫–æ–Ω–∫—É—Ä—Å">–û—Ç–∫—Ä—ã—Ç—ã–π –∫–æ–Ω–∫—É—Ä—Å</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">–í–∏–¥ –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞–∫—É–ø–∫–∏:</label>
                        <select id="category" name="category" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                            <option value="–¢–æ–≤–∞—Ä">–¢–æ–≤–∞—Ä</option>
                            <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
                            <option value="–£—Å–ª—É–≥–∞">–£—Å–ª—É–≥–∞</option>
                        </select>
                    </div>

                    <div>
                        <!-- –ù–ï –ó–ù–ê–Æ –ß–¢–û –î–ï–õ–ê–¢–¨ –° –ù–ï–ô
                        <button type="button" id="updateDataBtn" class="update-btn">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                        -->
                    </div>
                </div>
            </div>


            <div id="supplierStats" class="stats-bar hidden">
                <div class="stat-item">
                    <div class="stat-value" id="totalSuppliers">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueMethods">0</div>
                    <div class="stat-label">–°–ø–æ—Å–æ–±–æ–≤ –∑–∞–∫—É–ø–∫–∏</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueCategories">0</div>
                    <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentResults">0</div>
                    <div class="stat-label">–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</div>
                </div>
            </div>

            <div id="supplierResult" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>–¢–û–ü –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</h3>
                    <div id="dataSourceIndicator" style="font-size: 14px; color: #6c757d; font-style: italic;"></div>
                </div>

                <div id="loadingMessage" class="hidden">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å goszakup.gov.kz...</div>

                <div id="supplierTableContainer">
                    <table class="suppliers-table" id="suppliersTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="45%">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</th>
                                <th width="10%">–†–µ–π—Ç–∏–Ω–≥</th>
                                <th width="15%">–ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</th>
                                <th width="25%">–û–±—â–∞—è —Å—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="noResults" class="hidden" style="text-align: center; padding: 40px; color: #6c757d;">
                    <h4>ü§∑‚Äç‚ôÇÔ∏è –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p>
                    <button type="button" onclick="updateSuppliersData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å goszakup.gov.kz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSuppliers = [];
        let debounceTimer;


        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const resultDiv = document.getElementById('analysisResult');
            const resultCard = document.getElementById('result');

            resultCard.classList.remove('hidden');
            resultDiv.innerHTML = '<p>‚è≥ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞...</p>';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `
                        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ${data.law_type.toUpperCase()}</h3>
                        <p><strong>–§–∞–π–ª:</strong> ${data.filename}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong> <span style="font-weight: bold; color: ${
                            data.analysis.compliance_status === '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'green' :
                            data.analysis.compliance_status === '—á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'orange' : 'red'
                        }">${data.analysis.compliance_status}</span></p>
                        <p><strong>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:</strong> ${data.analysis.summary}</p>
                    `;

                    if (data.analysis.issues && data.analysis.issues.length > 0) {
                        html += '<h4>–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4><ul>';
                        data.analysis.issues.forEach(issue => {
                            html += `
                                <li style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #e74c3c;">
                                    <strong>${issue.article}:</strong> ${issue.issue}
                                    <br><em>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</em> ${issue.recommendation}
                                </li>
                            `;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: green; font-weight: bold;">‚úÖ –ù–∞—Ä—É—à–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</p>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSupplierModule();
        });

        document.getElementById('updateDataBtn').addEventListener('click', async function() {
            await updateSuppliersData();
        });

        async function initializeSupplierModule() {
            try {
                await loadStats();
                document.getElementById('purchase_method').addEventListener('change', handleFilterChange);
                document.getElementById('category').addEventListener('change', handleFilterChange);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/suppliers-stats');
                const stats = await response.json();
                document.getElementById('totalSuppliers').textContent = stats.total_suppliers || 0;
                document.getElementById('uniqueMethods').textContent = stats.unique_methods || 0;
                document.getElementById('uniqueCategories').textContent = stats.unique_categories || 0;
                document.getElementById('supplierStats').classList.remove('hidden');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        function handleFilterChange() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchSuppliers(true);
            }, 500);
        }

        async function searchSuppliers(useRealTime = true) {
            const method = document.getElementById('purchase_method').value;
            const category = document.getElementById('category').value;

            const resultDiv = document.getElementById('supplierResult');
            const loadingMessage = document.getElementById('loadingMessage');
            const tableBody = document.getElementById('supplierTableBody');
            const noResults = document.getElementById('noResults');
            const dataSourceIndicator = document.getElementById('dataSourceIndicator');

            loadingMessage.classList.remove('hidden');
            loadingMessage.innerHTML = 'üïí –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å goszakup.gov.kz...';
            tableBody.innerHTML = '';
            noResults.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            dataSourceIndicator.innerHTML = '';

            if (!method || !category) {
                loadingMessage.classList.add('hidden');
                noResults.classList.remove('hidden');
                document.getElementById('currentResults').textContent = '0';
                return;
            }

            try {
                const response = await fetch('/suppliers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        purchase_method: method,
                        category: category,
                        limit: 30
                    })
                });

                const data = await response.json();
                loadingMessage.classList.add('hidden');

                if (data.status === 'success' && data.suppliers.length > 0) {
                    currentSuppliers = data.suppliers;
                    renderSuppliersTable(currentSuppliers);
                    document.getElementById('currentResults').textContent = data.suppliers.length;

                    const isRealTimeData = data.suppliers.some(s => s.is_real_time);
                    if (isRealTimeData) {
                        dataSourceIndicator.innerHTML = '‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–∞–π—Ç–∞';
                        showNotification('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å goszakup.gov.kz', 'success');
                    } else {
                        dataSourceIndicator.innerHTML = 'üì¶ –î–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞';
                        showNotification('üì¶ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'info');
                    }
                    noResults.classList.add('hidden');
                } else {
                    currentSuppliers = [];
                    tableBody.innerHTML = '';
                    document.getElementById('currentResults').textContent = '0';
                    noResults.classList.remove('hidden');
                }
            } catch (err) {
                loadingMessage.classList.add('hidden');
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</td></tr>`;
                document.getElementById('currentResults').textContent = '0';
                noResults.classList.remove('hidden');
                dataSourceIndicator.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        function renderSuppliersTable(suppliers) {
    const tableBody = document.getElementById('supplierTableBody');
    tableBody.innerHTML = '';

    suppliers.forEach((supplier, index) => {
        const row = document.createElement('tr');


        const fullStars = '‚≠ê'.repeat(Math.floor(supplier.rating));
        const hasHalfStar = supplier.rating % 1 >= 0.5;
        const stars = fullStars + (hasHalfStar ? '¬Ω' : '');

        row.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td>
                <div class="supplier-name">${supplier.name}</div>
            </td>
            <td><span class="rating">${supplier.rating} ${stars}</span></td>
            <td>${supplier.contracts_count.toLocaleString()}</td>
            <td>${formatCurrency(supplier.total_sum)}</td>
        `;

        tableBody.appendChild(row);
    });
}

            function formatCurrency(amount) {

        const numAmount = typeof amount === 'string' ? parseFloat(amount.replace(/\s/g, '')) : amount;

        if (numAmount >= 1000000000) {
            return (numAmount / 1000000000).toFixed(1) + ' –º–ª—Ä–¥ ‚Ç∏';
        } else if (numAmount >= 1000000) {
            return (numAmount / 1000000).toFixed(1) + ' –º–ª–Ω ‚Ç∏';
        } else if (numAmount >= 1000) {
            return (numAmount / 1000).toFixed(1) + ' —Ç—ã—Å ‚Ç∏';
        } else {
            return numAmount.toLocaleString() + ' ‚Ç∏';
        }
    }

        async function updateSuppliersData() {
            const btn = document.getElementById('updateDataBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/update-suppliers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.status === 'success') {
                    await loadStats();
                    await searchSuppliers(true);
                    showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                } else {
                    showNotification('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 4px;
                color: white;
                z-index: 1000;
                font-weight: bold;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
</body>
</html>