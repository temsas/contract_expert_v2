<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden { display: none; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 25px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .format-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px; }
        .update-btn { background: #28a745; margin-left: 10px; }
        .update-btn:hover { background: #218838; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üîç –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 44-–§–ó –∏ 223-–§–ó</p>

        <div class="card">
            <h2>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h2>

            <div class="format-info">
                <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong> PDF, DOC, DOCX
            </div>

            <form id="uploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="law_type">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
                    <select id="law_type" name="law_type" required>
                        <option value="44_fz">44-–§–ó</option>
                        <option value="223_fz">223-–§–ó</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contract_file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç:</label>
                    <input type="file" id="contract_file" name="contract_file"
                           accept=".pdf,.doc,.docx" required>
                </div>

                <button type="submit" id="analyzeBtn">
                    {% if AI_AVAILABLE %}
                        üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                    {% else %}
                        ‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                    {% endif %}
                </button>
            </form>
        </div>

        <div id="result" class="card hidden">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
            <div id="analysisResult"></div>
        </div>

        <!-- ======================== -->
        <!-- üì¶ –ú–û–î–£–õ–¨ –ü–û–î–ë–û–†–ê –ü–û–°–¢–ê–í–©–ò–ö–û–í -->
        <!-- ======================== -->
        <div class="card">
            <h2>üì¶ –ü–æ–¥–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏–∑ goszakup.gov.kz</h2>

            <div class="format-info">
                <strong>–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞ goszakup.gov.kz</strong>
            </div>

            <form id="supplierForm">
                <div class="form-group">
                    <label for="purchase_method">–°–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏:</label>
                    <input type="text"
                           id="purchase_method"
                           name="purchase_method"
                           list="purchase_methods"
                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Å–ø–æ—Å–æ–± –∑–∞–∫—É–ø–∫–∏..."
                           value=""
                           required>
                    <datalist id="purchase_methods">
                        <option value="–ò–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—É—Ç–µ–º –ø—Ä—è–º–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞">
                        <option value="–ß–µ—Ä–µ–∑ —Ç–æ–≤–∞—Ä–Ω—ã–µ –±–∏—Ä–∂–∏">
                        <option value="–û—Ç–∫—Ä—ã—Ç—ã–π –∫–æ–Ω–∫—É—Ä—Å">
                        <option value="–ó–∞–ø—Ä–æ—Å —Ü–µ–Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π">
                        <option value="–ò–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø–æ –Ω–µ—Å–æ—Å—Ç–æ—è–≤—à–∏–º—Å—è –∑–∞–∫—É–ø–∫–∞–º">
                        <option value="–ê—É–∫—Ü–∏–æ–Ω (–¥–æ 2022)">
                        <option value="–ó–∞–∫—É–ø–∫–∞ –∂–∏–ª–∏—â–∞">
                        <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω">
                        <option value="–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –∫–æ–Ω–∫—É—Ä—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–∞–º–æ—á–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è">
                        <option value="–ò–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—É—Ç–µ–º –ø—Ä—è–º–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –æ–±—É—á–∞—é—â–∏—Ö—Å—è">
                        <option value="–ê—É–∫—Ü–∏–æ–Ω (—Å 2022)">
                        <option value="–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —É—Å–ª—É–≥–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–π—Ç–∏–Ω–≥–æ–≤–æ-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É ¬´–ø–æ–¥ –∫–ª—é—á¬ª">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–º –æ—Ç–±–æ—Ä–æ–º">
                        <option value="–ó–∞–∫—É–ø–∫–∞ –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Å–æ—Ü–∏–∞–ª—å–Ω–æ–º—É –∑–∞–∫–∞–∑—É">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å –ø–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—é —É—Å–ª—É–≥ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–∏—Ç–∞–Ω–∏—è –≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏–∫–æ–≤ –∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è">
                        <option value="–ö–æ–Ω–∫—É—Ä—Å –ø–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—é —Ç–æ–≤–∞—Ä–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º –ø–∏—Ç–∞–Ω–∏—è –≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏–∫–æ–≤ –∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è">
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="category">–í–∏–¥ –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞–∫—É–ø–∫–∏:</label>
                    <input type="text"
                           id="category"
                           name="category"
                           list="categories"
                           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é..."
                           value=""
                           required>
                    <datalist id="categories">
                        <option value="–¢–æ–≤–∞—Ä">
                        <option value="–†–∞–±–æ—Ç–∞">
                        <option value="–£—Å–ª—É–≥–∞">
                    </datalist>
                </div>

                <div>
                    <button type="submit">–ù–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</button>
                        <!-- –ö–ù–û–ü–ö–ê –û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï –¢–£–¢ –ï–°–õ–ò –ü–†–ò–ì–û–î–ò–¢–°–Ø -->
                </div>
            </form>

            <div id="supplierResult" class="hidden">
                <h3>–¢–û–ü –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</h3>
                <div id="supplierStats" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;"></div>
                <ul id="supplierList"></ul>
            </div>
        </div>
    </div>

        <script>
        // –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const resultDiv = document.getElementById('analysisResult');
            const resultCard = document.getElementById('result');

            resultCard.classList.remove('hidden');
            resultDiv.innerHTML = '<p>‚è≥ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞...</p>';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `
                        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ${data.law_type.toUpperCase()}</h3>
                        <p><strong>–§–∞–π–ª:</strong> ${data.filename}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong> <span style="font-weight: bold; color: ${
                            data.analysis.compliance_status === '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'green' :
                            data.analysis.compliance_status === '—á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç' ? 'orange' : 'red'
                        }">${data.analysis.compliance_status}</span></p>
                        <p><strong>–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:</strong> ${data.analysis.summary}</p>
                    `;

                    if (data.analysis.issues && data.analysis.issues.length > 0) {
                        html += '<h4>–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4><ul>';
                        data.analysis.issues.forEach(issue => {
                            html += `
                                <li style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #e74c3c;">
                                    <strong>${issue.article}:</strong> ${issue.issue}
                                    <br><em>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</em> ${issue.recommendation}
                                </li>
                            `;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: green; font-weight: bold;">‚úÖ –ù–∞—Ä—É—à–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</p>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
            }
        });

        // ========================
        // üì¶ –ü–û–î–ë–û–† –ü–û–°–¢–ê–í–©–ò–ö–û–í
        // ========================

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        document.getElementById('supplierForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await searchSuppliers();
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('updateDataBtn').addEventListener('click', async function() {
            await updateSuppliersData();
        });

        async function searchSuppliers() {
            const method = document.getElementById('purchase_method').value;
            const category = document.getElementById('category').value;

            const resultDiv = document.getElementById('supplierResult');
            const list = document.getElementById('supplierList');
            const statsDiv = document.getElementById('supplierStats');

            list.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</li>';
            statsDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch('/suppliers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        purchase_method: method,
                        category: category,
                        limit: 10
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.suppliers.length > 0) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    const statsResponse = await fetch('/api/suppliers-stats');
                    const stats = await statsResponse.json();

                    statsDiv.innerHTML = `
                        –í—Å–µ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –±–∞–∑–µ: <strong>${stats.total_suppliers || 0}</strong> |
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–∫—É–ø–∫–∏: <strong>${stats.unique_methods || 0}</strong> |
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: <strong>${stats.unique_categories || 0}</strong>
                    `;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
                    list.innerHTML = '';
                    data.suppliers.forEach((s, index) => {
                        list.innerHTML += `
                            <li style="margin-bottom: 15px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px;">
                                <strong>${index + 1}. ${s.name}</strong><br>
                                <span style="color: #666;">–†–µ–π—Ç–∏–Ω–≥: ${s.rating}‚≠ê | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: ${s.contracts_count.toLocaleString()} | –°—É–º–º–∞: ${s.total_sum.toLocaleString()} ‚Ç∏</span><br>
                                <small>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${s.category} | –°–ø–æ—Å–æ–±: ${s.purchase_method}</small>
                            </li>`;
                    });
                } else {
                    list.innerHTML = `
                        <li>‚ùå –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</li>
                        <li>
                            <button type="button" onclick="updateSuppliersData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å goszakup.gov.kz
                            </button>
                        </li>
                    `;
                    statsDiv.innerHTML = '–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
                }
            } catch (err) {
                list.innerHTML = `<li>–û—à–∏–±–∫–∞: ${err.message}</li>`;
                statsDiv.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
            }
        }

        async function updateSuppliersData() {
            const btn = document.getElementById('updateDataBtn');

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/update-suppliers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('‚úÖ ' + data.message);
                    // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    await searchSuppliers();
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–Ω–∞—á–µ–Ω–∏—è —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        });
    </script>
</body>
</html>