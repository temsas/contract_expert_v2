<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üîç –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 44-–§–ó –∏ 223-–§–ó</p>

        <div class="card">
            <h2>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h2>
            <button id="initBtn" onclick="initializeLaws()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–æ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
            <div id="initStatus"></div>
        </div>

        <div class="card">
            <h2>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="law_type">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
                    <select id="law_type" name="law_type" required>
                        <option value="44_fz">44-–§–ó</option>
                        <option value="223_fz">223-–§–ó</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contract_file">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç (PDF):</label>
                    <input type="file" id="contract_file" name="contract_file" accept=".pdf" required>
                </div>

                <button type="submit">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
            </form>
        </div>

        <div id="result" class="card hidden">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
            <div id="analysisResult"></div>
        </div>
    </div>

    <script>
        async function initializeLaws() {
            const btn = document.getElementById('initBtn');
            const status = document.getElementById('initStatus');

            btn.disabled = true;
            btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            status.innerHTML = '<p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</p>';

            try {
                const response = await fetch('/initialize-laws');
                const data = await response.json();

                if (data.status === 'success') {
                    status.innerHTML = `<p style="color: green;">‚úÖ ${data.message}</p>`;
                    if (data.laws_initialized) {
                        data.laws_initialized.forEach(law => {
                            status.innerHTML += `<p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${law.articles_count} —Å—Ç–∞—Ç–µ–π –¥–ª—è ${law.law}</p>`;
                        });
                    }
                } else {
                    status.innerHTML = `<p style="color: red;">‚ùå ${data.message}</p>`;
                }
            } catch (error) {
                status.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–æ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const resultDiv = document.getElementById('analysisResult');
            const resultCard = document.getElementById('result');

            resultCard.classList.remove('hidden');
            resultDiv.innerHTML = '<p>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞...</p>';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `
                        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ${data.law_type.toUpperCase()}</h3>
                        <p><strong>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:</strong> ${data.analysis.compliance_status}</p>
                        <p><strong>–û–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:</strong> ${data.analysis.summary}</p>
                    `;

                    if (data.analysis.issues && data.analysis.issues.length > 0) {
                        html += '<h4>–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4><ul>';
                        data.analysis.issues.forEach(issue => {
                            html += `
                                <li>
                                    <strong>–°—Ç–∞—Ç—å—è ${issue.article}:</strong> ${issue.issue}
                                    <br><em>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</em> ${issue.recommendation}
                                </li>
                            `;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p>‚úÖ –ù–∞—Ä—É—à–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</p>';
                    }

                    html += `<details><summary>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</summary><pre>${data.contract_preview}</pre></details>`;

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error}</p>`;
            }
        });
    </script>
</body>
</html>